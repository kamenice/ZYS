/*
 * Copyright (c) 2020 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include <stdio.h>
#include <string.h>
#include <stddef.h>
#include "wifiiot_gpio.h"
#include "wifiiot_gpio_ex.h"
#include "wifiiot_i2c.h"
#include "wifiiot_errno.h"
#include "oled_display.h"

/* OLED I2C Command/Data modes */
#define OLED_I2C_CMD            0x00
#define OLED_I2C_DATA           0x40

/* Array size helper */
#define ARRAY_SIZE(a)           (sizeof(a) / sizeof((a)[0]))

/* Font data - 6x8 ASCII characters starting from space (0x20) */
static const unsigned char F6x8[][6] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* space */
    {0x00, 0x00, 0x00, 0x2f, 0x00, 0x00}, /* ! */
    {0x00, 0x00, 0x07, 0x00, 0x07, 0x00}, /* " */
    {0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14}, /* # */
    {0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12}, /* $ */
    {0x00, 0x62, 0x64, 0x08, 0x13, 0x23}, /* % */
    {0x00, 0x36, 0x49, 0x55, 0x22, 0x50}, /* & */
    {0x00, 0x00, 0x05, 0x03, 0x00, 0x00}, /* ' */
    {0x00, 0x00, 0x1c, 0x22, 0x41, 0x00}, /* ( */
    {0x00, 0x00, 0x41, 0x22, 0x1c, 0x00}, /* ) */
    {0x00, 0x14, 0x08, 0x3E, 0x08, 0x14}, /* * */
    {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08}, /* + */
    {0x00, 0x00, 0x00, 0xA0, 0x60, 0x00}, /* , */
    {0x00, 0x08, 0x08, 0x08, 0x08, 0x08}, /* - */
    {0x00, 0x00, 0x60, 0x60, 0x00, 0x00}, /* . */
    {0x00, 0x20, 0x10, 0x08, 0x04, 0x02}, /* / */
    {0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E}, /* 0 */
    {0x00, 0x00, 0x42, 0x7F, 0x40, 0x00}, /* 1 */
    {0x00, 0x42, 0x61, 0x51, 0x49, 0x46}, /* 2 */
    {0x00, 0x21, 0x41, 0x45, 0x4B, 0x31}, /* 3 */
    {0x00, 0x18, 0x14, 0x12, 0x7F, 0x10}, /* 4 */
    {0x00, 0x27, 0x45, 0x45, 0x45, 0x39}, /* 5 */
    {0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30}, /* 6 */
    {0x00, 0x01, 0x71, 0x09, 0x05, 0x03}, /* 7 */
    {0x00, 0x36, 0x49, 0x49, 0x49, 0x36}, /* 8 */
    {0x00, 0x06, 0x49, 0x49, 0x29, 0x1E}, /* 9 */
    {0x00, 0x00, 0x36, 0x36, 0x00, 0x00}, /* : */
    {0x00, 0x00, 0x56, 0x36, 0x00, 0x00}, /* ; */
    {0x00, 0x08, 0x14, 0x22, 0x41, 0x00}, /* < */
    {0x00, 0x14, 0x14, 0x14, 0x14, 0x14}, /* = */
    {0x00, 0x00, 0x41, 0x22, 0x14, 0x08}, /* > */
    {0x00, 0x02, 0x01, 0x51, 0x09, 0x06}, /* ? */
    {0x00, 0x32, 0x49, 0x59, 0x51, 0x3E}, /* @ */
    {0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C}, /* A */
    {0x00, 0x7F, 0x49, 0x49, 0x49, 0x36}, /* B */
    {0x00, 0x3E, 0x41, 0x41, 0x41, 0x22}, /* C */
    {0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C}, /* D */
    {0x00, 0x7F, 0x49, 0x49, 0x49, 0x41}, /* E */
    {0x00, 0x7F, 0x09, 0x09, 0x09, 0x01}, /* F */
    {0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A}, /* G */
    {0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F}, /* H */
    {0x00, 0x00, 0x41, 0x7F, 0x41, 0x00}, /* I */
    {0x00, 0x20, 0x40, 0x41, 0x3F, 0x01}, /* J */
    {0x00, 0x7F, 0x08, 0x14, 0x22, 0x41}, /* K */
    {0x00, 0x7F, 0x40, 0x40, 0x40, 0x40}, /* L */
    {0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F}, /* M */
    {0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F}, /* N */
    {0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E}, /* O */
    {0x00, 0x7F, 0x09, 0x09, 0x09, 0x06}, /* P */
    {0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E}, /* Q */
    {0x00, 0x7F, 0x09, 0x19, 0x29, 0x46}, /* R */
    {0x00, 0x46, 0x49, 0x49, 0x49, 0x31}, /* S */
    {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01}, /* T */
    {0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F}, /* U */
    {0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F}, /* V */
    {0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F}, /* W */
    {0x00, 0x63, 0x14, 0x08, 0x14, 0x63}, /* X */
    {0x00, 0x07, 0x08, 0x70, 0x08, 0x07}, /* Y */
    {0x00, 0x61, 0x51, 0x49, 0x45, 0x43}, /* Z */
    {0x00, 0x00, 0x7F, 0x41, 0x41, 0x00}, /* [ */
    {0x00, 0x02, 0x04, 0x08, 0x10, 0x20}, /* \ */
    {0x00, 0x00, 0x41, 0x41, 0x7F, 0x00}, /* ] */
    {0x00, 0x04, 0x02, 0x01, 0x02, 0x04}, /* ^ */
    {0x00, 0x40, 0x40, 0x40, 0x40, 0x40}, /* _ */
    {0x00, 0x00, 0x01, 0x02, 0x04, 0x00}, /* ` */
    {0x00, 0x20, 0x54, 0x54, 0x54, 0x78}, /* a */
    {0x00, 0x7F, 0x48, 0x44, 0x44, 0x38}, /* b */
    {0x00, 0x38, 0x44, 0x44, 0x44, 0x20}, /* c */
    {0x00, 0x38, 0x44, 0x44, 0x48, 0x7F}, /* d */
    {0x00, 0x38, 0x54, 0x54, 0x54, 0x18}, /* e */
    {0x00, 0x08, 0x7E, 0x09, 0x01, 0x02}, /* f */
    {0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C}, /* g */
    {0x00, 0x7F, 0x08, 0x04, 0x04, 0x78}, /* h */
    {0x00, 0x00, 0x44, 0x7D, 0x40, 0x00}, /* i */
    {0x00, 0x40, 0x80, 0x84, 0x7D, 0x00}, /* j */
    {0x00, 0x7F, 0x10, 0x28, 0x44, 0x00}, /* k */
    {0x00, 0x00, 0x41, 0x7F, 0x40, 0x00}, /* l */
    {0x00, 0x7C, 0x04, 0x18, 0x04, 0x78}, /* m */
    {0x00, 0x7C, 0x08, 0x04, 0x04, 0x78}, /* n */
    {0x00, 0x38, 0x44, 0x44, 0x44, 0x38}, /* o */
    {0x00, 0xFC, 0x24, 0x24, 0x24, 0x18}, /* p */
    {0x00, 0x18, 0x24, 0x24, 0x18, 0xFC}, /* q */
    {0x00, 0x7C, 0x08, 0x04, 0x04, 0x08}, /* r */
    {0x00, 0x48, 0x54, 0x54, 0x54, 0x20}, /* s */
    {0x00, 0x04, 0x3F, 0x44, 0x40, 0x20}, /* t */
    {0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C}, /* u */
    {0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C}, /* v */
    {0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C}, /* w */
    {0x00, 0x44, 0x28, 0x10, 0x28, 0x44}, /* x */
    {0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C}, /* y */
    {0x00, 0x44, 0x64, 0x54, 0x4C, 0x44}, /* z */
};

/* I2C write helper */
static uint32_t I2cWriteByte(uint8_t regAddr, uint8_t byte)
{
    uint8_t buffer[] = {regAddr, byte};
    WifiIotI2cData i2cData = {0};

    i2cData.sendBuf = buffer;
    i2cData.sendLen = sizeof(buffer);

    return I2cWrite(OLED_I2C_IDX, OLED_I2C_ADDR, &i2cData);
}

static uint32_t WriteCmd(uint8_t cmd)
{
    return I2cWriteByte(OLED_I2C_CMD, cmd);
}

static uint32_t WriteData(uint8_t data)
{
    return I2cWriteByte(OLED_I2C_DATA, data);
}

static void OledSetPosition(uint8_t x, uint8_t y)
{
    WriteCmd(0xb0 + y);
    WriteCmd(((x & 0xf0) >> 4) | 0x10);
    WriteCmd(x & 0x0f);
}

static void OledShowChar(uint8_t x, uint8_t y, char ch)
{
    uint8_t c = ch - ' ';
    if (x > OLED_WIDTH - 6) {
        x = 0;
        y++;
    }

    OledSetPosition(x, y);
    for (int i = 0; i < 6; i++) {
        WriteData(F6x8[c][i]);
    }
}

static void OledShowString(uint8_t x, uint8_t y, const char *str)
{
    if (str == NULL) {
        return;
    }

    while (*str) {
        OledShowChar(x, y, *str);
        x += 6;
        if (x > OLED_WIDTH - 6) {
            x = 0;
            y++;
        }
        str++;
    }
}

void OLED_DisplayInit(void)
{
    static const uint8_t initCmds[] = {
        0xAE, /* Display off */
        0x00, /* Set low column address */
        0x10, /* Set high column address */
        0x40, /* Set start line address */
        0xB0, /* Set page address */
        0x81, /* Contrast control */
        0xFF, /* 128 */
        0xA1, /* Set segment remap */
        0xA6, /* Normal / reverse */
        0xA8, /* Set multiplex ratio */
        0x3F, /* 1/64 duty */
        0xC8, /* COM scan direction */
        0xD3, /* Set display offset */
        0x00,
        0xD5, /* Set OSC division */
        0x80,
        0xD8, /* Set area color mode off */
        0x05,
        0xD9, /* Set pre-charge period */
        0xF1,
        0xDA, /* Set COM pin configuration */
        0x12,
        0xDB, /* Set VCOMH */
        0x30,
        0x8D, /* Set charge pump enable */
        0x14,
        0xAF, /* Display on */
    };

    /* Note: I2C is already initialized in main.c I2C_CommonInit()
     * Do NOT reinitialize here to avoid conflicts
     */

    /* Send initialization commands */
    for (size_t i = 0; i < ARRAY_SIZE(initCmds); i++) {
        WriteCmd(initCmds[i]);
    }

    OLED_DisplayClear();
    printf("[OLED] Display initialized\r\n");
}

void OLED_DisplayClear(void)
{
    for (uint8_t y = 0; y < 8; y++) {
        WriteCmd(0xb0 + y);
        WriteCmd(0x00);
        WriteCmd(0x10);
        for (uint8_t x = 0; x < OLED_WIDTH; x++) {
            WriteData(0x00);
        }
    }
}

void OLED_DisplayWeight(double weight, int isOverweight)
{
    char buf[24];
    snprintf(buf, sizeof(buf), "Wt:%.1fg %s", weight, isOverweight ? "OVR" : "   ");
    OledShowString(0, DISPLAY_LINE_WEIGHT, buf);
}

void OLED_DisplayConveyorStatus(int isRunning, int isJammed)
{
    char buf[24];
    const char *status = isRunning ? "RUN" : "STP";
    const char *jam = isJammed ? " JAM!" : "     ";
    snprintf(buf, sizeof(buf), "St:%s%s", status, jam);
    OledShowString(0, DISPLAY_LINE_STATUS, buf);
}

void OLED_DisplayTemperature(float temperature, int isOverheated)
{
    char buf[24];
    snprintf(buf, sizeof(buf), "Tp:%.1fC %s", temperature, isOverheated ? "HOT" : "   ");
    OledShowString(0, DISPLAY_LINE_TEMP, buf);
}

void OLED_DisplaySpeedAndTime(float speedRPM, uint32_t runTimeSeconds)
{
    char buf[24];
    uint32_t mins = runTimeSeconds / 60;
    uint32_t secs = runTimeSeconds % 60;
    snprintf(buf, sizeof(buf), "Sp:%.0f T:%02u:%02u", speedRPM, mins, secs);
    OledShowString(0, DISPLAY_LINE_SPEED, buf);
}

void OLED_DisplayUpdate(double weight, int isOverweight,
                        int isRunning, int isJammed,
                        float temperature, int isOverheated,
                        float speedRPM, uint32_t runTimeSeconds)
{
    OLED_DisplayWeight(weight, isOverweight);
    OLED_DisplayConveyorStatus(isRunning, isJammed);
    OLED_DisplayTemperature(temperature, isOverheated);
    OLED_DisplaySpeedAndTime(speedRPM, runTimeSeconds);
}

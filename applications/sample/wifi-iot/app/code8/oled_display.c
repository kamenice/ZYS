/*
 * Copyright (c) 2020 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <unistd.h>
#include "cmsis_os2.h"
#include "wifiiot_gpio.h"
#include "wifiiot_gpio_ex.h"
#include "wifiiot_i2c.h"
#include "wifiiot_errno.h"
#include "conveyor_system.h"
#include "oled_display.h"

#define OLED_I2C_IDX    WIFI_IOT_I2C_IDX_0
#define OLED_I2C_ADDR   0x78
#define OLED_I2C_CMD    0x00
#define OLED_I2C_DATA   0x40

#define OLED_WIDTH      128
#define OLED_HEIGHT     64

#define TASK_STACK_SIZE 2048

static osMutexId_t g_i2cMutex = NULL;

/* 6x8 font data for basic ASCII characters */
static const unsigned char F6x8[][6] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* space */
    {0x00, 0x00, 0x00, 0x2f, 0x00, 0x00}, /* ! */
    {0x00, 0x00, 0x07, 0x00, 0x07, 0x00}, /* " */
    {0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14}, /* # */
    {0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12}, /* $ */
    {0x00, 0x62, 0x64, 0x08, 0x13, 0x23}, /* % */
    {0x00, 0x36, 0x49, 0x55, 0x22, 0x50}, /* & */
    {0x00, 0x00, 0x05, 0x03, 0x00, 0x00}, /* ' */
    {0x00, 0x00, 0x1c, 0x22, 0x41, 0x00}, /* ( */
    {0x00, 0x00, 0x41, 0x22, 0x1c, 0x00}, /* ) */
    {0x00, 0x14, 0x08, 0x3E, 0x08, 0x14}, /* * */
    {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08}, /* + */
    {0x00, 0x00, 0x00, 0xA0, 0x60, 0x00}, /* , */
    {0x00, 0x08, 0x08, 0x08, 0x08, 0x08}, /* - */
    {0x00, 0x00, 0x60, 0x60, 0x00, 0x00}, /* . */
    {0x00, 0x20, 0x10, 0x08, 0x04, 0x02}, /* / */
    {0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E}, /* 0 */
    {0x00, 0x00, 0x42, 0x7F, 0x40, 0x00}, /* 1 */
    {0x00, 0x42, 0x61, 0x51, 0x49, 0x46}, /* 2 */
    {0x00, 0x21, 0x41, 0x45, 0x4B, 0x31}, /* 3 */
    {0x00, 0x18, 0x14, 0x12, 0x7F, 0x10}, /* 4 */
    {0x00, 0x27, 0x45, 0x45, 0x45, 0x39}, /* 5 */
    {0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30}, /* 6 */
    {0x00, 0x01, 0x71, 0x09, 0x05, 0x03}, /* 7 */
    {0x00, 0x36, 0x49, 0x49, 0x49, 0x36}, /* 8 */
    {0x00, 0x06, 0x49, 0x49, 0x29, 0x1E}, /* 9 */
    {0x00, 0x00, 0x36, 0x36, 0x00, 0x00}, /* : */
    {0x00, 0x00, 0x56, 0x36, 0x00, 0x00}, /* ; */
    {0x00, 0x08, 0x14, 0x22, 0x41, 0x00}, /* < */
    {0x00, 0x14, 0x14, 0x14, 0x14, 0x14}, /* = */
    {0x00, 0x00, 0x41, 0x22, 0x14, 0x08}, /* > */
    {0x00, 0x02, 0x01, 0x51, 0x09, 0x06}, /* ? */
    {0x00, 0x32, 0x49, 0x59, 0x51, 0x3E}, /* @ */
    {0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C}, /* A */
    {0x00, 0x7F, 0x49, 0x49, 0x49, 0x36}, /* B */
    {0x00, 0x3E, 0x41, 0x41, 0x41, 0x22}, /* C */
    {0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C}, /* D */
    {0x00, 0x7F, 0x49, 0x49, 0x49, 0x41}, /* E */
    {0x00, 0x7F, 0x09, 0x09, 0x09, 0x01}, /* F */
    {0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A}, /* G */
    {0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F}, /* H */
    {0x00, 0x00, 0x41, 0x7F, 0x41, 0x00}, /* I */
    {0x00, 0x20, 0x40, 0x41, 0x3F, 0x01}, /* J */
    {0x00, 0x7F, 0x08, 0x14, 0x22, 0x41}, /* K */
    {0x00, 0x7F, 0x40, 0x40, 0x40, 0x40}, /* L */
    {0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F}, /* M */
    {0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F}, /* N */
    {0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E}, /* O */
    {0x00, 0x7F, 0x09, 0x09, 0x09, 0x06}, /* P */
    {0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E}, /* Q */
    {0x00, 0x7F, 0x09, 0x19, 0x29, 0x46}, /* R */
    {0x00, 0x46, 0x49, 0x49, 0x49, 0x31}, /* S */
    {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01}, /* T */
    {0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F}, /* U */
    {0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F}, /* V */
    {0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F}, /* W */
    {0x00, 0x63, 0x14, 0x08, 0x14, 0x63}, /* X */
    {0x00, 0x07, 0x08, 0x70, 0x08, 0x07}, /* Y */
    {0x00, 0x61, 0x51, 0x49, 0x45, 0x43}, /* Z */
    {0x00, 0x00, 0x7F, 0x41, 0x41, 0x00}, /* [ */
    {0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55}, /* backslash */
    {0x00, 0x00, 0x41, 0x41, 0x7F, 0x00}, /* ] */
    {0x00, 0x04, 0x02, 0x01, 0x02, 0x04}, /* ^ */
    {0x00, 0x40, 0x40, 0x40, 0x40, 0x40}, /* _ */
    {0x00, 0x00, 0x01, 0x02, 0x04, 0x00}, /* ` */
    {0x00, 0x20, 0x54, 0x54, 0x54, 0x78}, /* a */
    {0x00, 0x7F, 0x48, 0x44, 0x44, 0x38}, /* b */
    {0x00, 0x38, 0x44, 0x44, 0x44, 0x20}, /* c */
    {0x00, 0x38, 0x44, 0x44, 0x48, 0x7F}, /* d */
    {0x00, 0x38, 0x54, 0x54, 0x54, 0x18}, /* e */
    {0x00, 0x08, 0x7E, 0x09, 0x01, 0x02}, /* f */
    {0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C}, /* g */
    {0x00, 0x7F, 0x08, 0x04, 0x04, 0x78}, /* h */
    {0x00, 0x00, 0x44, 0x7D, 0x40, 0x00}, /* i */
    {0x00, 0x40, 0x80, 0x84, 0x7D, 0x00}, /* j */
    {0x00, 0x7F, 0x10, 0x28, 0x44, 0x00}, /* k */
    {0x00, 0x00, 0x41, 0x7F, 0x40, 0x00}, /* l */
    {0x00, 0x7C, 0x04, 0x18, 0x04, 0x78}, /* m */
    {0x00, 0x7C, 0x08, 0x04, 0x04, 0x78}, /* n */
    {0x00, 0x38, 0x44, 0x44, 0x44, 0x38}, /* o */
    {0x00, 0xFC, 0x24, 0x24, 0x24, 0x18}, /* p */
    {0x00, 0x18, 0x24, 0x24, 0x18, 0xFC}, /* q */
    {0x00, 0x7C, 0x08, 0x04, 0x04, 0x08}, /* r */
    {0x00, 0x48, 0x54, 0x54, 0x54, 0x20}, /* s */
    {0x00, 0x04, 0x3F, 0x44, 0x40, 0x20}, /* t */
    {0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C}, /* u */
    {0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C}, /* v */
    {0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C}, /* w */
    {0x00, 0x44, 0x28, 0x10, 0x28, 0x44}, /* x */
    {0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C}, /* y */
    {0x00, 0x44, 0x64, 0x54, 0x4C, 0x44}, /* z */
};

static uint32_t I2C_WriteByte(uint8_t regAddr, uint8_t byte)
{
    uint8_t buffer[] = {regAddr, byte};
    WifiIotI2cData i2cData = {0};
    i2cData.sendBuf = buffer;
    i2cData.sendLen = sizeof(buffer);

    if (g_i2cMutex) {
        osMutexAcquire(g_i2cMutex, osWaitForever);
    }
    uint32_t ret = I2cWrite(OLED_I2C_IDX, OLED_I2C_ADDR, &i2cData);
    if (g_i2cMutex) {
        osMutexRelease(g_i2cMutex);
    }
    return ret;
}

static uint32_t WriteCmd(uint8_t cmd)
{
    return I2C_WriteByte(OLED_I2C_CMD, cmd);
}

static uint32_t WriteData(uint8_t data)
{
    return I2C_WriteByte(OLED_I2C_DATA, data);
}

static void OledSetPosition(uint8_t x, uint8_t y)
{
    WriteCmd(0xb0 + y);
    WriteCmd(((x & 0xf0) >> 4) | 0x10);
    WriteCmd(x & 0x0f);
}

static void OledFillScreen(uint8_t fillData)
{
    uint8_t m, n;
    for (m = 0; m < 8; m++) {
        WriteCmd(0xb0 + m);
        WriteCmd(0x00);
        WriteCmd(0x10);
        for (n = 0; n < 128; n++) {
            WriteData(fillData);
        }
    }
}

static void OledShowChar(uint8_t x, uint8_t y, uint8_t ch)
{
    uint8_t c, i;
    c = ch - ' ';
    if (c >= sizeof(F6x8) / sizeof(F6x8[0])) {
        return;
    }
    if (x > OLED_WIDTH - 1) {
        x = 0;
        y++;
    }
    OledSetPosition(x, y);
    for (i = 0; i < 6; i++) {
        WriteData(F6x8[c][i]);
    }
}

static void OledShowString(uint8_t x, uint8_t y, const char *str)
{
    if (str == NULL) return;
    while (*str) {
        OledShowChar(x, y, *str);
        x += 6;
        if (x > 122) {
            x = 0;
            y++;
        }
        str++;
    }
}

void OledDisplayInit(void)
{
    static const uint8_t initCmds[] = {
        0xAE, /* Display off */
        0x00, /* Set low column address */
        0x10, /* Set high column address */
        0x40, /* Set start line address */
        0xB0, /* Set page address */
        0x81, /* Contract control */
        0xFF, /* 128 */
        0xA1, /* Set segment remap */
        0xA6, /* Normal/reverse */
        0xA8, /* Set multiplex ratio (1 to 64) */
        0x3F, /* 1/64 duty */
        0xC8, /* Com scan direction */
        0xD3, /* Set display offset */
        0x00,
        0xD5, /* Set osc division */
        0x80,
        0xD8, /* Set area color mode off */
        0x05,
        0xD9, /* Set Pre-Charge Period */
        0xF1,
        0xDA, /* Set com pin configuration */
        0x12,
        0xDB, /* Set Vcomh */
        0x30,
        0x8D, /* Set charge pump enable */
        0x14,
        0xAF, /* Turn on oled panel */
    };

    /* Create I2C mutex */
    if (g_i2cMutex == NULL) {
        osMutexAttr_t attr = {0};
        g_i2cMutex = osMutexNew(&attr);
    }

    /* Initialize I2C0 */
    IoSetFunc(WIFI_IOT_IO_NAME_GPIO_13, WIFI_IOT_IO_FUNC_GPIO_13_I2C0_SDA);
    IoSetFunc(WIFI_IOT_IO_NAME_GPIO_14, WIFI_IOT_IO_FUNC_GPIO_14_I2C0_SCL);
    I2cInit(OLED_I2C_IDX, 400000);

    /* Initialize OLED */
    for (size_t i = 0; i < sizeof(initCmds); i++) {
        WriteCmd(initCmds[i]);
    }

    OledFillScreen(0x00);
    printf("[OLED] Initialized\n");
}

static void OledTask(void *arg)
{
    (void)arg;
    char buf[32];
    ConveyorState *state = GetConveyorState();

    while (1) {
        OledFillScreen(0x00);

        /* Line 0: Title */
        OledShowString(0, 0, "Smart Conveyor");

        /* Line 2: Item detection status */
        snprintf(buf, sizeof(buf), "Item: %s", state->item_detected ? "YES" : "NO ");
        OledShowString(0, 2, buf);

        /* Line 4: Temperature */
        snprintf(buf, sizeof(buf), "Temp: %.1fC", state->temperature);
        OledShowString(0, 4, buf);

        /* Line 6: Motor status */
        snprintf(buf, sizeof(buf), "Motor: %s", state->motor_running ? "RUN " : "STOP");
        OledShowString(0, 6, buf);

        sleep(1);
    }
}

void StartOledTask(void)
{
    osThreadAttr_t attr = {0};
    attr.name = "OledTask";
    attr.stack_size = TASK_STACK_SIZE;
    attr.priority = osPriorityNormal;

    if (osThreadNew(OledTask, NULL, &attr) == NULL) {
        printf("[OLED] Failed to create OledTask\n");
    }
}
